{% extends 'base.html' %}

{% block title %}Dr. {{ doctor.user.get_full_name }}{% endblock %}

{% block content %}
<div class="py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Doctor Profile</h1>
        <a href="{% url 'doctor_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to List
        </a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <!-- Doctor Image or Placeholder -->
                    {% if doctor.image %}
                        <img src="{{ doctor.image.url }}" alt="Dr. {{ doctor.user.get_full_name }}" 
                             class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover; border: 3px solid #0d6efd;">
                    {% else %}
                        <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center mb-3" 
                             style="width: 150px; height: 150px;">
                            <i class="bi bi-person fs-1 text-white"></i>
                        </div>
                    {% endif %}
                    
                    <h3>Dr. {{ doctor.user.get_full_name }}</h3>
                    <p class="text-muted">{{ doctor.get_specialization_display }}</p>
                    <span class="badge bg-{% if doctor.is_available %}success{% else %}danger{% endif %}">
                        {% if doctor.is_available %}Available{% else %}Not Available{% endif %}
                    </span>
                    
                    <!-- Upload Image Button -->
                    <div class="mt-3">
                        <label class="btn btn-sm btn-warning" style="cursor: pointer; margin: 0;">
                            <i class="bi bi-cloud-upload"></i> Upload Image
                            <input type="file" id="imageInput" accept="image/*" 
                                   style="display: none;" data-doctor-id="{{ doctor.pk }}"
                                   data-doctor-name="Dr. {{ doctor.user.get_full_name }}">
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Professional Information</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <th width="200">License Number:</th>
                            <td>{{ doctor.license_number }}</td>
                        </tr>
                        <tr>
                            <th>Specialization:</th>
                            <td>{{ doctor.get_specialization_display }}</td>
                        </tr>
                        <tr>
                            <th>Qualification:</th>
                            <td>{{ doctor.qualification }}</td>
                        </tr>
                        <tr>
                            <th>Experience:</th>
                            <td>{{ doctor.experience_years }} years</td>
                        </tr>
                        <tr>
                            <th>Consultation Fee:</th>
                            <td>{{ doctor.consultation_fee }} ETB</td>
                        </tr>
                        <tr>
                            <th>Available Days:</th>
                            <td>{{ doctor.available_days }}</td>
                        </tr>
                        <tr>
                            <th>Available Time:</th>
                            <td>{{ doctor.available_time_start }} - {{ doctor.available_time_end }}</td>
                        </tr>
                        <tr>
                            <th>Contact:</th>
                            <td>{{ doctor.user.phone }}</td>
                        </tr>
                        <tr>
                            <th>Email:</th>
                            <td>{{ doctor.user.email }}</td>
                        </tr>
                    </table>
                    
                    <div class="mt-3">
                        <a href="{% url 'appointment_create' %}?doctor={{ doctor.pk }}" class="btn btn-primary">
                            <i class="bi bi-calendar-plus"></i> Book Appointment
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Handle file input change
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const doctorId = this.getAttribute('data-doctor-id');
        const doctorName = this.getAttribute('data-doctor-name');

        // Validate file
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            return;
        }

        // Show uploading status
        const button = this.parentElement;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
        button.style.pointerEvents = 'none';

        // Upload file
        const formData = new FormData();
        formData.append('image', file);

        fetch(`/api/doctors/doctors/${doctorId}/upload_image/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Upload failed');
            }
        })
        .then(data => {
            // Update the image immediately
            if (data.image) {
                // Create new image element
                const newImg = document.createElement('img');
                newImg.src = data.image + '?t=' + new Date().getTime();
                newImg.alt = `Dr. ${data.full_name}`;
                newImg.className = 'rounded-circle mb-3';
                newImg.style.cssText = 'width: 150px; height: 150px; object-fit: cover; border: 3px solid #0d6efd;';
                
                // Replace placeholder with image
                const cardBody = document.querySelector('.card-body');
                const oldImage = cardBody.querySelector('img, .rounded-circle');
                if (oldImage) {
                    oldImage.replaceWith(newImg);
                }
            }

            // Show success message
            button.innerHTML = '<i class="bi bi-check-circle"></i> âœ“ Uploaded!';
            button.style.backgroundColor = '#28a745';
            
            // Reset button after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.style.pointerEvents = 'auto';
                button.style.backgroundColor = '';
                // Reset file input
                this.value = '';
            }, 2000);
        })
        .catch(error => {
            alert('Upload failed: ' + error.message);
            button.innerHTML = originalHTML;
            button.style.pointerEvents = 'auto';
            this.value = '';
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
</div>
{% endblock %}
